<!DOCTYPE html>
<html lang="fr-FR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Page d'affiliation</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="preload" as="image" href="{{DESKTOP_PRINT}}" media="(min-width: 769px)">
<link rel="preload" as="image" href="{{MOBILE_PRINT}}" media="(max-width: 768px)">

<style>
:root{
  --desktop-bg-image:url('{{DESKTOP_PRINT}}');
  --mobile-bg-image:url('{{MOBILE_PRINT}}');
}

*{margin:0;padding:0;box-sizing:border-box}

html,body{
  height:100%;
  width:100%;
  overflow:hidden;
  font-family:Poppins,sans-serif;
}

/* BACKGROUND */
.background-container{
  position:fixed;
  inset:0;
  background:#000;
  background-image:var(--desktop-bg-image);
  background-size:cover;
  background-position:center;
  filter:brightness(.8);
  z-index:-1;
}

@media(max-width:768px){
  .background-container{
    background-image:var(--mobile-bg-image);
  }
}

/* OVERLAY */
#cookie-popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:.4s ease;
  z-index:1000;
  padding: 20px; /* Adiciona padding geral para mobile */
}

#cookie-popup.show{
  opacity:1;
  pointer-events:auto;
}

/* POPUP */
.popup{
  background:#fff;
  border-radius:20px;
  max-width:600px;
  width:100%;
  padding:40px 32px;
  text-align:center;
  box-shadow:0 25px 50px rgba(0,0,0,.3);
  transform:scale(.95);
  transition:.3s ease;
  position:relative;
  overflow: hidden; /* CORREÇÃO 1: Linha não sai do quadrado */
}

#cookie-popup.show .popup{transform:scale(1)}

.popup::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:4px;
  background:linear-gradient(90deg,#4f46e5,#7c3aed,#ec4899);
}

h2{
  font-size:28px;
  font-weight:700;
  color:#1f2937;
  margin-bottom:16px;
}

p{
  font-size:16px;
  color:#6b7280;
  line-height:1.5;
  margin-bottom:32px;
}

.buttons{
  display:flex;
  gap:16px;
  justify-content:center;
  margin-bottom:24px;
}

.btn{
  padding:16px 32px;
  border-radius:16px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  border:2px solid #e5e7eb;
  text-decoration:none;
  min-width:140px;
  transition:.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* ESTILOS DO LOADING SPINNER */
.spinner{
  display: none; /* Escondido por padrão */
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  margin-right: 8px;
}

/* Mostra o spinner quando a classe .loading está no botão */
.btn.loading .spinner{
  display: inline-block;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Estilo específico para spinner no botão Fermer (Cinza) */
.btn-close.loading .spinner {
  border-color: rgba(55, 65, 81, 0.2); /* Borda cinza clara */
  border-top-color: #374151; /* Topo cinza escuro */
}

.btn-accept{
  background:linear-gradient(135deg,#10b981,#059669);
  color:#fff;
  border-color:#10b981;
}

.btn-accept:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(16,185,129,.35);
}

.btn-close{
  background:#f8fafc;
  color:#374151;
}

.btn-close:hover{
  background:#e5e7eb;
}

/* Estado geral de loading (aplica a qualquer botão com a classe) */
.btn.loading{
  opacity: 0.9;
  cursor: wait; 
  transform: none;
  box-shadow: none;
}

.footer{
  border-top:1px solid #e5e7eb;
  padding-top:16px;
  font-size:12px;
  color:#9ca3af;
}

/* AJUSTE 2: RESPONSIVIDADE MOBILE MELHORADA */
@media(max-width:600px){
  .popup{
    padding:24px 20px;
    margin: 0 10px; /* Cria espaço nas laterais */
    width: auto;
  }

  h2{
    font-size:22px;
    margin-bottom:12px;
  }

  p{
    font-size:14px;
    margin-bottom:24px;
  }

  .buttons{
    flex-direction:column;
    gap:12px;
  }

  .btn{
    width:100%;
    padding:12px 20px;
    font-size:15px;
  }
}
</style>
</head>

<body>

<div class="background-container"></div>

<div id="cookie-popup">
  <div class="popup">
    <h2>Politique de cookies</h2>
    <p>
      Ce site web utilise des cookies pour personnaliser le contenu et analyser le trafic.
      En cliquant sur “Autoriser”, vous acceptez notre politique de cookies.
    </p>

    <div class="buttons">
      <button class="btn btn-accept" id="acceptBtn">
        <span class="spinner"></span>
        <span class="btn-text">Autoriser</span>
      </button>
      <button class="btn btn-close" id="closeBtn">
        <span class="spinner"></span>
        <span class="btn-text">Fermer</span>
      </button>
    </div>

    <div class="footer">Votre confidentialité est importante pour nous</div>
  </div>
</div>

<script>
const AFFILIATE_LINK = "{{AFFILIATE_LINK}}";
let redirected = false;

// Elementos do DOM
const popupEl = document.getElementById('cookie-popup');
const acceptBtn = document.getElementById('acceptBtn');
const closeBtn = document.getElementById('closeBtn');
const allButtons = document.querySelectorAll('.btn');

// Função para resetar o estado de ambos os botões
function resetState() {
    redirected = false;
    
    allButtons.forEach(btn => {
        btn.classList.remove('loading');
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
        
        // Reseta o texto original baseado na classe
        const textSpan = btn.querySelector('.btn-text');
        if(btn.classList.contains('btn-accept')) textSpan.textContent = "Autoriser";
        if(btn.classList.contains('btn-close')) textSpan.textContent = "Fermer";
    });
    
    // Garante que o popup apareça
    popupEl.classList.add('show');
}

// A função go agora recebe o botão clicado como argumento (this)
function go(clickedBtn) {
    if(redirected) return; 
    redirected = true;

    // 1. Desabilitar todos os botões para evitar cliques duplos
    allButtons.forEach(btn => {
        if(btn !== clickedBtn) {
            btn.style.opacity = '0.5'; // Escurece o botão não clicado
            btn.style.pointerEvents = 'none'; // Impede clique
        }
    });

    // 2. Ativar o estado de "loading" no botão clicado
    clickedBtn.classList.add('loading');
    clickedBtn.disabled = true;
    
    // Muda o texto do botão clicado para "Vérification..."
    const textSpan = clickedBtn.querySelector('.btn-text');
    textSpan.textContent = "Vérification...";

    // 3. Delay e Redirecionamento
    setTimeout(() => {
        if(typeof window.runTrackerRedirect === "function"){
            window.runTrackerRedirect(AFFILIATE_LINK);
        }else{
            window.location.href = AFFILIATE_LINK;
        }
    }, 1500);
}

// Passamos "this" para que a função saiba qual botão foi clicado
acceptBtn.onclick = function() { go(this); };
closeBtn.onclick  = function() { go(this); };

// 1. Inicializa ao carregar
window.addEventListener('load', resetState);

// 2. Lógica do Botão Voltar (Back Button)
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        resetState(); // Libera o clique e mostra o popup se o usuário voltar
    }
});
</script>

</body>
</html>